        -:    0:Source:D:/Project_mp/testfinal/test/compare.c
        -:    0:Programs:14
        -:    1:#include "testhead.h"
        -:    2:// function for testing the output with the expected output
       21:    3:unsigned short int Test_ing(const unsigned char ModbusTcpTxBuf[], const unsigned char Test_tx[])
        -:    4:{   
       21:    5:    Test_Res = 1;
       21:    6:    test_c = 0;
        -:    7:
        -:    8:    // Data enter check for FC 0x06
       21:    9:    if (ModbusTcpRxBuf[7] == 0x06)
        -:   10:    {
        3:   11:        add = (ModbusTcpRxBuf[8] << 8) | ModbusTcpRxBuf[9];
        3:   12:        test_c = (Dataregister[add] != ((ModbusTcpRxBuf[10] << 8) | ModbusTcpRxBuf[11])) ? 1 : 0;
        -:   13:    }
        -:   14:
        -:   15:    // Data enter check for FC  0x10
       21:   16:    if (ModbusTcpRxBuf[7] == 0x10)
        -:   17:    {
        3:   18:        add = (ModbusTcpRxBuf[8] << 8) | ModbusTcpRxBuf[9];
        3:   19:        numRegisters = (ModbusTcpRxBuf[10] << 8) | ModbusTcpRxBuf[11];
        -:   20:
        9:   21:        for (increment = 0; increment < numRegisters; increment++)
        -:   22:        {
        6:   23:            receivedData = (ModbusTcpRxBuf[13 + increment * 2] << 8) | ModbusTcpRxBuf[14 + increment * 2];
        6:   24:            test_c = (Dataregister[add + increment] != receivedData) ? 1 : 0;
        -:   25:        }
        -:   26:    }
        -:   27: 
        -:   28:    // Data enter check for FC  0x05
       21:   29:    if (ModbusTcpRxBuf[7] == 0x05)
        -:   30:    {
        3:   31:        int reg = (ModbusTcpRxBuf[9] - 1) / 16;
        3:   32:        int bit = (ModbusTcpRxBuf[9] - 1) % 16;
        -:   33:
        3:   34:        if (ModbusTcpRxBuf[10] == 0xff)
        -:   35:        {
        2:   36:            SET(regis[reg], bit);
        -:   37:        }
        -:   38:        else
        -:   39:        {
        1:   40:            CLR(regis[reg], bit);
        -:   41:        }
        -:   42:       // printf("\n%04x - %04x", COIL[reg],regis[reg]);
        3:   43:        test_c = (COIL[reg] != regis[reg]) ? 1 : 0;
        -:   44:    }
        -:   45:
       21:   46:    if (ModbusTcpRxBuf[7] == 0x0f)
        -:   47:    {
        -:   48:        unsigned int bit_count, reg, regbit, a, b, d;
        -:   49:        unsigned short int c[25];
        -:   50:
       15:   51:        for (int i = 0; i < ModbusTcpRxBuf[12]; i++)
        -:   52:        {
       12:   53:            c[i] = (ModbusTcpRxBuf[(i * 2) + 14] << 8) | ModbusTcpRxBuf[(i * 2) + 13];
        -:   54:        }
        -:   55:
       63:   56:        for (bit_count = ModbusTcpRxBuf[11] - 1; bit_count >= 0; bit_count--)
        -:   57:        {
      123:   58:            regbit = ((ModbusTcpRxBuf[9] + bit_count) - 1) % 16;
       63:   59:            reg = ((ModbusTcpRxBuf[9] + bit_count) - 1) / 16;
        -:   60:
       63:   61:            a = bit_count % 16;
       63:   62:            b = bit_count / 16;
        -:   63:
       63:   64:            d = GET_BIT(c[b], a);
        -:   65:
       63:   66:            if (d == 0x1)
        -:   67:            {
       34:   68:                SET(COIL1[reg], regbit);
        -:   69:            }
        -:   70:            else
        -:   71:            {
       29:   72:                CLR(COIL1[reg], regbit);
        -:   73:            }
       63:   74:            if (bit_count == 0)
        -:   75:            {
        3:   76:                break;
        -:   77:            }
        -:   78:        }
        3:   79:        reg = ((ModbusTcpRxBuf[9] + bit_count) - 1) / 16;
        6:   80:        for (int i = reg; i <= reg +(ModbusTcpRxBuf[12]/2); i++)
        -:   81:        {
        -:   82:            //printf("\n%04x--%04x  ", COIL[i], COIL1[i]);
        5:   83:            if ((COIL[i] != COIL1[i]))
        -:   84:            {
        2:   85:                test_c = 1;
        2:   86:                break;
        -:   87:            }
        -:   88:        }
        -:   89:    }
        -:   90:
       21:   91:    numRegisters = (ModbusTcpTxBuf[7] < 0x80) ? (0x09 + ModbusTcpTxBuf[8]) : 0x09;
        -:   92:    // send packet check for all function code
      223:   93:    for (increment = 0; increment < numRegisters; increment++)
        -:   94:    {
        -:   95:        // Test_Res = (ModbusTcpTxBuf[increment] != Test_tx[increment]) ? 0 : 1;
      202:   96:        if ((ModbusTcpTxBuf[increment] != Test_tx[increment]))
        -:   97:        {
    #####:   98:            Test_Res = 0;
    #####:   99:            break; // Exit the loop or block
        -:  100:        }
        -:  101:    }
        -:  102:
       21:  103:    return Test_Res;
        -:  104:}
