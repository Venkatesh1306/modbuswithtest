        -:    0:Source:D:/Project_mp/testfinal/Modbus1/packet_parser.c
        -:    0:Programs:14
        -:    1:#include "testingdata.h"
        -:    2:unsigned int c2, d2, l2, bytesrx;
        -:    3:unsigned char exceptioncode;
        -:    4:
       21:    5:WORD deserialize(parse1 *parse, BYTE *ModbusTcpRxBuf)
        -:    6:{
        -:    7:    // BYTE ModbusTcpTxBuf[0];
        -:    8:
       21:    9:    parse->TransactionID.v[1] = ModbusTcpRxBuf[0];
       21:   10:    parse->TransactionID.v[0] = ModbusTcpRxBuf[1];
       21:   11:    parse->ProtocolID.v[1] = ModbusTcpRxBuf[2];
       21:   12:    parse->ProtocolID.v[0] = ModbusTcpRxBuf[3];
       21:   13:    parse->Length = ModbusTcpRxBuf[5];
       21:   14:    parse->UnitID = ModbusTcpRxBuf[6];
       21:   15:    parse->FunctionCode = ModbusTcpRxBuf[7];
       21:   16:    parse->StartAddress.v[1] = ModbusTcpRxBuf[8];
       21:   17:    parse->StartAddress.v[0] = ModbusTcpRxBuf[9];
       21:   18:    if (parse->FunctionCode == 0x05)
        -:   19:    {
        3:   20:        parse->ForceData[0].v[1] = ModbusTcpRxBuf[10];
        3:   21:        parse->ForceData[0].v[0] = ModbusTcpRxBuf[11];
        -:   22:    }
        -:   23:    else
        -:   24:    {
       18:   25:        parse->NumberofRegister.v[1] = ModbusTcpRxBuf[10];
       18:   26:        parse->NumberofRegister.v[0] = ModbusTcpRxBuf[11];
        -:   27:    }
        -:   28:
       21:   29:    if (parse->FunctionCode == ForceMultipleCoils) // force multiple coils
        -:   30:    {
        3:   31:        parse->ByteCount = ModbusTcpRxBuf[12];
        9:   32:        for (c2 = 0; c2 < parse->ByteCount/2; c2++)
        -:   33:        {
        -:   34:
        6:   35:            parse->Coil_data[c2] = (ModbusTcpRxBuf[14 + c2*2] << 8) | ModbusTcpRxBuf[13 + c2*2];
        -:   36:            //printf("%04x \n",parse->Coil_data[c2]);
        -:   37:        }
        -:   38:        
        -:   39:    }
        -:   40:
       21:   41:    if (parse->FunctionCode == PresetMultipleRegisters)
        -:   42:    { // Preset multiple register
        -:   43:
        3:   44:        parse->ByteCount = ModbusTcpRxBuf[12];
        -:   45:        //        l2 = parse->ByteCount % 2;
        -:   46:        //
        -:   47:        //        if (l2 != 0) {
        -:   48:        //            l2 = (parse->ByteCount / 2) + 1;
        -:   49:        //        } else {
        -:   50:        //            l2 = parse->ByteCount / 2;
        -:   51:        //        }
        -:   52:
        9:   53:        for (c2 = 0; c2 < parse->NumberofRegister.v[0]; c2++)
        -:   54:        {
        6:   55:            d2 = c2 * 2;
        -:   56:
        6:   57:            parse->ForceData[c2].v[1] = ModbusTcpRxBuf[13 + d2];
        6:   58:            parse->ForceData[c2].v[0] = ModbusTcpRxBuf[14 + d2];
        -:   59:        }
        -:   60:    }
       21:   61:    bytesrx = 0x6 + parse->Length;
       21:   62:    return bytesrx;
        -:   63:}
